<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gestfy • Estoque</title>
  <link rel="icon" href="../images/logo.png">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body class="admin-body">

<header class="admin-header">
  <img src="../images/logo.png" class="logo" alt="Gestfy">
  <h1>CONTROLE DE ESTOQUE</h1>
  <p class="subtitle">Rastreamento de movimentações e quantidade</p>
</header>

<main class="container">

  <!-- ESTATÍSTICAS -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total de Produtos</h3>
      <p class="stat-value" id="totalProdutos">0</p>
    </div>
    <div class="stat-card">
      <h3>Entradas Hoje</h3>
      <p class="stat-value" id="entradasHoje">0</p>
    </div>
    <div class="stat-card">
      <h3>Saídas Hoje</h3>
      <p class="stat-value" id="saidasHoje">0</p>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <h2 class="section-title">Filtros</h2>
    <div class="filter-grid">
      <select id="filtroTipo" class="select-filter">
        <option value="">Todas as movimentações</option>
        <option value="ENTRADA">Entradas</option>
        <option value="SAIDA">Saídas</option>
      </select>
      <input type="date" id="filtroData" class="select-filter">
      <button class="btn" onclick="carregarEstoque()"> Recarregar</button>
    </div>
  </div>

  <!-- TABELA DE MOVIMENTAÇÕES -->
  <div class="card card-full">
    <h2 class="section-title">Movimentações de Estoque</h2>
    <div style="overflow-x: auto;">
      <table class="tabela">
        <thead>
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Tipo</th>
            <th>Quantidade</th>
            <th>Data/Hora</th>
          </tr>
        </thead>
        <tbody id="estoqueList">
          <tr><td colspan="5" style="text-align: center; color: #999;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p id="msg" class="msg"></p>

</main>

<footer>
  <p>© 2025 <span>Gestfy</span> • Módulo de Estoque</p>
</footer>

<script>
  const API_URL = "http://localhost:8080/api/estoque";
  const estoqueList = document.getElementById("estoqueList");
  const msg = document.getElementById("msg");

  // Carregar estoque ao abrir página
  async function carregarEstoque() {
    try {
      const filtroTipo = document.getElementById("filtroTipo").value;
      const filtroData = document.getElementById("filtroData").value;
      
      let url = API_URL;
      if (filtroTipo) url += `?tipo=${filtroTipo}`;
      if (filtroData) url += (filtroTipo ? "&" : "?") + `data=${filtroData}`;

      const response = await fetch(url);
      
      if (!response.ok) {
        if (response.status === 404) {
          estoqueList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #bbb;">Nenhuma movimentação encontrada</td></tr>';
          return;
        }
        throw new Error("Erro ao buscar estoque");
      }

      const movimentacoes = await response.json();
      
      if (!Array.isArray(movimentacoes) || movimentacoes.length === 0) {
        estoqueList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #bbb;">Nenhuma movimentação encontrada</td></tr>';
        atualizarEstatisticas([]);
        return;
      }

      estoqueList.innerHTML = "";
      movimentacoes.forEach(mov => {
        const row = document.createElement("tr");
        const tipo = mov.tipoMovimento || mov.tipo || "---";
        const badge = tipo === "ENTRADA" ? "✅" : "❌";
        
        row.innerHTML = `
          <td>#${mov.id}</td>
          <td>${mov.produtoNome || mov.produto?.nome || "Produto " + mov.produtoId}</td>
          <td><span class="badge">${badge} ${tipo}</span></td>
          <td>${mov.quantidade} un.</td>
          <td>${new Date(mov.dataMovimento).toLocaleString("pt-BR")}</td>
        `;
        estoqueList.appendChild(row);
      });

      atualizarEstatisticas(movimentacoes);
    } catch (error) {
      console.error(error);
      estoqueList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f44;"> Erro ao carregar</td></tr>';
      msg.textContent = "❌ " + error.message;
      msg.style.display = "block";
    }
  }

  function atualizarEstatisticas(movimentacoes) {
    const hoje = new Date().toLocaleDateString("pt-BR");
    const entradas = movimentacoes.filter(m => (m.tipoMovimento || m.tipo) === "ENTRADA").length;
    const saidas = movimentacoes.filter(m => (m.tipoMovimento || m.tipo) === "SAIDA").length;

    document.getElementById("totalProdutos").textContent = new Set(movimentacoes.map(m => m.produtoId)).size;
    document.getElementById("entradasHoje").textContent = entradas;
    document.getElementById("saidasHoje").textContent = saidas;
  }

  // Carregar ao abrir página
  carregarEstoque();

  // Auto-refresh a cada 30 segundos
  setInterval(() => {
    carregarEstoque();
  }, 30000);
</script>

</body>
</html>
