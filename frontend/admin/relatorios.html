<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gestfy ‚Ä¢ Relat√≥rios</title>
  <link rel="icon" href="../images/logo.png">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body class="admin-body">

<header class="admin-header">
  <img src="../images/logo.png" class="logo" alt="Gestfy">
  <h1>RELAT√ìRIOS E AN√ÅLISES</h1>
  <p class="subtitle">Vendas, estoque e dados financeiros</p>
</header>

<main class="container">

  <!-- ESTAT√çSTICAS GERAIS -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Vendido (Hoje)</h3>
      <p class="stat-value" id="totalVendido">R$ 0,00</p>
    </div>
    <div class="stat-card">
      <h3>Quantidade de Vendas</h3>
      <p class="stat-value" id="qtdVendas">0</p>
    </div>
    <div class="stat-card">
      <h3>Ticket M√©dio</h3>
      <p class="stat-value" id="ticketMedio">R$ 0,00</p>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <h2 class="section-title">Per√≠odo</h2>
    <div class="filter-grid">
      <input type="date" id="dataInicio" class="select-filter">
      <input type="date" id="dataFim" class="select-filter">
      <button class="btn" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
      <button class="btn" style="background: #34a853;" onclick="exportarCSV()">üíæ Exportar CSV</button>
    </div>
  </div>

  <!-- RELAT√ìRIO DE VENDAS POR DIA -->
  <div class="card card-full">
    <h2 class="section-title">Vendas por Dia</h2>
    <div style="overflow-x: auto;">
      <table class="tabela">
        <thead>
          <tr>
            <th>Data</th>
            <th>Quantidade de Vendas</th>
            <th>Total (R$)</th>
            <th>Ticket M√©dio</th>
          </tr>
        </thead>
        <tbody id="relatorioList">
          <tr><td colspan="4" style="text-align: center; color: #999;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- RELAT√ìRIO DE ESTOQUE -->
  <div class="card card-full">
    <h2 class="section-title">Status do Estoque</h2>
    <div style="overflow-x: auto;">
      <table class="tabela">
        <thead>
          <tr>
            <th>Produto</th>
            <th>√öltimas Entradas</th>
            <th>√öltimas Sa√≠das</th>
            <th>Data √öltima Movimenta√ß√£o</th>
          </tr>
        </thead>
        <tbody id="estoqueList">
          <tr><td colspan="4" style="text-align: center; color: #999;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p id="msg" class="msg"></p>

</main>

<footer>
  <p>¬© 2025 <span>Gestfy</span> ‚Ä¢ M√≥dulo de Relat√≥rios</p>
</footer>

<script>
  const API_RELATORIOS = "https://gestfy-backend.onrender.com/api/relatorios";
  const API_ESTOQUE = "https://gestfy-backend.onrender.com/api/estoque";
  const msg = document.getElementById("msg");

  // Definir datas padr√£o (√∫ltimos 7 dias)
  function definirDatas() {
    const hoje = new Date();
    const seteDiasAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById("dataInicio").value = seteDiasAtras.toISOString().split("T")[0];
    document.getElementById("dataFim").value = hoje.toISOString().split("T")[0];
  }

  // Gerar relat√≥rio
  async function gerarRelatorio() {
    try {
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      if (!dataInicio || !dataFim) {
        msg.textContent = "‚ö†Ô∏è Selecione as datas";
        msg.style.display = "block";
        return;
      }

      // Carregar vendas por dia
      await carregarVendasPorDia(dataInicio);
      
      // Carregar estoque
      await carregarStatusEstoque();

      msg.textContent = "‚úÖ Relat√≥rio gerado com sucesso";
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 3000);
    } catch (error) {
      console.error(error);
      msg.textContent = "‚ùå " + error.message;
      msg.style.display = "block";
    }
  }

  async function carregarVendasPorDia(data) {
    try {
      const response = await fetch(`${API_RELATORIOS}/vendas-por-dia?data=${data}`);
      
      if (!response.ok) {
        document.getElementById("relatorioList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhuma venda encontrada</td></tr>';
        atualizarEstatisticas([]);
        return;
      }

      const venda = await response.json();
      
      document.getElementById("relatorioList").innerHTML = "";
      
      // Exibir dados do relat√≥rio
      const row = document.createElement("tr");
      const total = venda.totalVendas || 0;
      const qtd = venda.quantidadePedidos || 0;
      const ticketMedio = qtd > 0 ? total / qtd : 0;

      row.innerHTML = `
        <td>${new Date(venda.data).toLocaleDateString("pt-BR")}</td>
        <td>${qtd}</td>
        <td>R$ ${total.toFixed(2)}</td>
        <td>R$ ${ticketMedio.toFixed(2)}</td>
      `;
      document.getElementById("relatorioList").appendChild(row);

      // Atualizar estat√≠sticas
      document.getElementById("totalVendido").textContent = "R$ " + total.toFixed(2);
      document.getElementById("qtdVendas").textContent = qtd;
      document.getElementById("ticketMedio").textContent = "R$ " + ticketMedio.toFixed(2);

    } catch (error) {
      console.error(error);
      document.getElementById("relatorioList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #f44;">‚ùå Erro ao carregar vendas</td></tr>';
    }
  }

  async function carregarStatusEstoque() {
    try {
      const response = await fetch(API_ESTOQUE);
      
      if (!response.ok) {
        document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhuma movimenta√ß√£o encontrada</td></tr>';
        return;
      }

      const movimentacoes = await response.json();
      
      if (!Array.isArray(movimentacoes) || movimentacoes.length === 0) {
        document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhuma movimenta√ß√£o encontrada</td></tr>';
        return;
      }

      // Agrupar por produto
      const porProduto = {};
      movimentacoes.forEach(mov => {
        const produtoNome = mov.produtoNome || "Produto " + mov.produtoId;
        if (!porProduto[produtoNome]) {
          porProduto[produtoNome] = { entradas: 0, saidas: 0, ultima: null };
        }
        
        const tipo = mov.tipoMovimento;
        if (tipo === "ENTRADA") porProduto[produtoNome].entradas += mov.quantidade || 1;
        if (tipo === "SAIDA") porProduto[produtoNome].saidas += mov.quantidade || 1;
        
        porProduto[produtoNome].ultima = new Date(mov.dataMovimento);
      });

      document.getElementById("estoqueList").innerHTML = "";
      Object.entries(porProduto).forEach(([nome, dados]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${nome}</td>
          <td>üì• ${dados.entradas}</td>
          <td>üì§ ${dados.saidas}</td>
          <td>${dados.ultima ? dados.ultima.toLocaleString("pt-BR") : "---"}</td>
        `;
        document.getElementById("estoqueList").appendChild(row);
      });

    } catch (error) {
      console.error(error);
      document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #f44;">‚ùå Erro ao carregar estoque</td></tr>';
    }
  }

  // Exportar para CSV
  function exportarCSV() {
    const dataInicio = document.getElementById("dataInicio").value;
    const dataFim = document.getElementById("dataFim").value;

    if (!dataInicio || !dataFim) {
      alert("‚ö†Ô∏è Selecione as datas primeiro");
      return;
    }

    const tabela = document.getElementById("relatorioList");
    let csv = "Data,Quantidade,Total (R$),Ticket M√©dio\n";

    tabela.querySelectorAll("tr").forEach(tr => {
      const cells = [];
      tr.querySelectorAll("td").forEach(td => {
        cells.push(td.textContent);
      });
      csv += cells.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `relatorio_vendas_${dataInicio}_${dataFim}.csv`;
    a.click();
  }

  // Inicializar
  definirDatas();
  gerarRelatorio();
</script>

<script src="../js/auth.js"></script>
</body>
</html>
