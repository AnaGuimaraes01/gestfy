<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gestfy • Relatórios</title>
  <link rel="icon" href="../images/logo.png">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body class="admin-body">

<header class="admin-header">
  <div style="display: flex; align-items: center; gap: 12px;">
    <button onclick="history.back()" class="btn-voltar" title="Voltar">←</button>
    <div>
      <h1>RELATÓRIOS E ANÁLISES</h1>
      <p class="subtitle">Vendas, estoque e dados financeiros</p>
    </div>
  </div>
</header>

<main class="container">

  <!-- ESTATÍSTICAS GERAIS -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Vendido (Hoje)</h3>
      <p class="stat-value" id="totalVendido">R$ 0,00</p>
    </div>
    <div class="stat-card">
      <h3>Quantidade de Vendas</h3>
      <p class="stat-value" id="qtdVendas">0</p>
    </div>
    <div class="stat-card">
      <h3>Ticket Médio</h3>
      <p class="stat-value" id="ticketMedio">R$ 0,00</p>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <h2 class="section-title">Período</h2>
    <div class="filter-grid">
      <input type="date" id="dataInicio" class="select-filter">
      <input type="date" id="dataFim" class="select-filter">
      <button class="btn" onclick="gerarRelatorio()">Gerar Relatório</button>
      <button class="btn" style="background: #34a853;" onclick="exportarCSV()">Exportar CSV</button>
    </div>
  </div>

  <!-- RELATÓRIO DE VENDAS POR DIA -->
  <div class="card card-full">
    <h2 class="section-title">Vendas por Dia</h2>
    <div style="overflow-x: auto;">
      <table class="tabela">
        <thead>
          <tr>
            <th>Data</th>
            <th>Quantidade de Vendas</th>
            <th>Total (R$)</th>
            <th>Ticket Médio</th>
          </tr>
        </thead>
        <tbody id="relatorioList">
          <tr><td colspan="4" style="text-align: center; color: #999;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- RELATÓRIO DE ESTOQUE -->
  <div class="card card-full">
    <h2 class="section-title">Status de Produtos</h2>
    <div style="overflow-x: auto;">
      <table class="tabela">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Preço Unitário</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="estoqueList">
          <tr><td colspan="4" style="text-align: center; color: #999;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p id="msg" class="msg"></p>

</main>

<footer>
  <p>© 2025 <span>Gestfy</span> • Módulo de Relatórios</p>
</footer>

<script>
  const API_RELATORIOS = "https://gestfy-backend.onrender.com/api/relatorios";
  const API_ESTOQUE = "https://gestfy-backend.onrender.com/api/estoque";
  const msg = document.getElementById("msg");

  // Definir datas padrão (últimos 7 dias)
  function definirDatas() {
    const hoje = new Date();
    const seteDiasAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById("dataInicio").value = seteDiasAtras.toISOString().split("T")[0];
    document.getElementById("dataFim").value = hoje.toISOString().split("T")[0];
  }

  // Gerar relatório
  async function gerarRelatorio() {
    try {
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      if (!dataInicio || !dataFim) {
        msg.textContent = "Selecione as datas";
        msg.style.display = "block";
        return;
      }

      // Carregar vendas por dia
      await carregarVendasPorDia(dataInicio);
      
      // Carregar estoque
      await carregarStatusEstoque();

      msg.textContent = "Relatório gerado com sucesso";
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 3000);
    } catch (error) {
      console.error(error);
      msg.textContent = "Erro: " + error.message;
      msg.style.display = "block";
    }
  }

  async function carregarVendasPorDia(data) {
    try {
      const response = await fetch(`${API_RELATORIOS}/vendas-por-dia?data=${data}`);
      
      if (!response.ok) {
        document.getElementById("relatorioList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhuma venda encontrada</td></tr>';
        atualizarEstatisticas([]);
        return;
      }

      const venda = await response.json();
      
      document.getElementById("relatorioList").innerHTML = "";
      
      // Exibir dados do relatório
      const row = document.createElement("tr");
      const total = venda.totalVendas || 0;
      const qtd = venda.quantidadePedidos || 0;
      const ticketMedio = qtd > 0 ? total / qtd : 0;

      row.innerHTML = `
        <td>${new Date(venda.data).toLocaleDateString("pt-BR")}</td>
        <td>${qtd}</td>
        <td>R$ ${total.toFixed(2)}</td>
        <td>R$ ${ticketMedio.toFixed(2)}</td>
      `;
      document.getElementById("relatorioList").appendChild(row);

      // Atualizar estatísticas
      document.getElementById("totalVendido").textContent = "R$ " + total.toFixed(2);
      document.getElementById("qtdVendas").textContent = qtd;
      document.getElementById("ticketMedio").textContent = "R$ " + ticketMedio.toFixed(2);

    } catch (error) {
      console.error(error);
      document.getElementById("relatorioList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #f44;">Erro ao carregar vendas</td></tr>';
    }
  }

  async function carregarStatusEstoque() {
    try {
      const response = await fetch(API_RELATORIOS + "/produtos");
      
      if (!response.ok) {
        document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhum produto encontrado</td></tr>';
        return;
      }

      const produtos = await response.json();
      
      if (!Array.isArray(produtos) || produtos.length === 0) {
        document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #bbb;">Nenhum produto encontrado</td></tr>';
        return;
      }

      document.getElementById("estoqueList").innerHTML = "";
      produtos.forEach(produto => {
        const row = document.createElement("tr");
        const status = produto.quantidade <= 0 ? "Em Falta" : produto.quantidade <= 5 ? "Baixo" : "Disponível";
        const statusColor = produto.quantidade <= 0 ? "#f44" : produto.quantidade <= 5 ? "#ffa500" : "#4caf50";
        
        row.innerHTML = `
          <td>${produto.nome}</td>
          <td>${produto.quantidade} un.</td>
          <td>R$ ${(produto.preco || 0).toFixed(2)}</td>
          <td><span style="color: ${statusColor}; font-weight: 600;">${status}</span></td>
        `;
        document.getElementById("estoqueList").appendChild(row);
      });

    } catch (error) {
      console.error(error);
      document.getElementById("estoqueList").innerHTML = '<tr><td colspan="4" style="text-align: center; color: #f44;">Erro ao carregar produtos</td></tr>';
    }
  }

  // Exportar para CSV
  function exportarCSV() {
    const dataInicio = document.getElementById("dataInicio").value;
    const dataFim = document.getElementById("dataFim").value;

    if (!dataInicio || !dataFim) {
      alert("Selecione as datas primeiro");
      return;
    }

    const tabela = document.getElementById("relatorioList");
    let csv = "Data,Quantidade,Total (R$),Ticket Médio\n";

    tabela.querySelectorAll("tr").forEach(tr => {
      const cells = [];
      tr.querySelectorAll("td").forEach(td => {
        cells.push(td.textContent);
      });
      csv += cells.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `relatorio_vendas_${dataInicio}_${dataFim}.csv`;
    a.click();
  }

  // Inicializar
  definirDatas();
  gerarRelatorio();
</script>

<script src="../js/auth.js"></script>

<style>
  .btn-voltar { 
    background: none; 
    border: none; 
    font-size: 24px; 
    color: var(--rosa); 
    cursor: pointer; 
    padding: 8px;
  }
  .btn-voltar:hover { 
    opacity: 0.8; 
  }
</style>
</body>
</html>
